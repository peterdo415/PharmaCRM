name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # Supabase
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF:  ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD:  ${{ secrets.SUPABASE_DB_PASSWORD }}
      # Vercel
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Supabase Project
        run: |
          supabase link \
            --project-ref "$SUPABASE_PROJECT_REF" \
            --password    "$SUPABASE_DB_PASSWORD"

      - name: Apply Supabase Migrations
        run: supabase db push

      # Edge Functions は未作成なのでコメントアウト
      # - name: Deploy Supabase Edge Functions
      #   run: supabase functions deploy

      - name: Deploy Frontend to Vercel
        id: vercel_deploy
        uses: amondnet/vercel-action@v20
        with:
          vercel-token:       ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id:      ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id:  ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory:  .
          alias-domains: pharma-crm-git-main-kosuke-fujimotos-projects.vercel.app

      - name: Capture deployed URL
        id: capture_url
        run: |
          DEPLOY_URL="${{ steps.vercel_deploy.outputs.preview-url }}"
          if [ -z "$DEPLOY_URL" ]; then
            echo "No deployment URL found" >&2
            exit 1
          fi
          echo "DEPLOY_URL=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      - name: Use deployment URL
        run: |
          echo "Frontend live at: ${{ steps.capture_url.outputs.DEPLOY_URL }}"
