name: Deploy to Production          # â† ã“ã“ã¯å¤‰æ›´ä¸è¦ã¨ã®ã”è¦æœ›ã©ãŠã‚Šæ®ãˆç½®ã

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # â”€â”€â”€â”€â”€ å…±é€šç’°å¢ƒå¤‰æ•°ï¼ˆGitHub Secrets ã«ç™»éŒ²ã—ã¦ãŠãï¼‰ â”€â”€â”€â”€â”€
    env:
      # Supabase
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF:  ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD:  ${{ secrets.SUPABASE_DB_PASSWORD }}

      # Vercel
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
      - uses: actions/checkout@v3

      # 2. Supabase CLI æœ€æ–°ç‰ˆ
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # 3. Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯
      - name: Link to Supabase
        run: |
          supabase link \
            --project-ref "$SUPABASE_PROJECT_REF" \
            --password    "$SUPABASE_DB_PASSWORD"

      # 4. ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
      - name: Apply Supabase migrations
        run: supabase db push

      # Edge Functions æœªåˆ©ç”¨ãªã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      # - name: Deploy Supabase Edge Functions
      #   run: supabase functions deploy

      # 5. Node + Vercel CLI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js & Vercel CLI
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install -g vercel@latest   # vercel CLI ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

      # 6. Vercel ã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆURL ã‚’ $GITHUB_OUTPUT çµŒç”±ã§å¾Œç¶šã¸æ¸¡ã™ï¼‰
      - name: Deploy Frontend to Vercel
        id: vercel_deploy
        shell: bash
        run: |
          # â”€â”€â”€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªãƒ³ã‚¯ï¼ˆéžå¯¾è©±ï¼‰ â”€â”€â”€
          vercel link --project $VERCEL_PROJECT_ID \
                      --yes \
                      --token $VERCEL_TOKEN \
                      --scope $VERCEL_ORG_ID

          # â”€â”€â”€ ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤ â”€â”€â”€
          vercel build --prod \
                       --token $VERCEL_TOKEN \
                       --scope $VERCEL_ORG_ID

          DEPLOY_URL=$(vercel deploy --prebuilt --prod --yes \
                                     --token $VERCEL_TOKEN \
                                     --scope $VERCEL_ORG_ID)

          # â”€â”€â”€ URL ã‚’ç’°å¢ƒãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ï¼ˆset-output ã¯ä½¿ã‚ãªã„ï¼‰ â”€â”€â”€
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      # 7. ãƒ‡ãƒ—ãƒ­ã‚¤ URL åˆ©ç”¨ä¾‹
      - name: Post deployment info
        run: |
          echo "ðŸš€ Frontend is live at: ${{ steps.vercel_deploy.outputs.url }}"
