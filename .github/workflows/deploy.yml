name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Supabase
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF:  ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD:  ${{ secrets.SUPABASE_DB_PASSWORD }}
      # Vercel
      VERCEL_TOKEN:          ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:         ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID:     ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      # 1. コード取得
      - uses: actions/checkout@v3

      # 2. Supabase CLI インストール（最新版）
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # 3. Supabase プロジェクトに非対話リンク
      - name: Link to Supabase Project
        run: |
          supabase link \
            --project-ref "$SUPABASE_PROJECT_REF" \
            --password    "$SUPABASE_DB_PASSWORD"

      # 4. Supabase マイグレーション適用
      - name: Apply Supabase Migrations
        run: supabase db push

      # 5. Supabase Edge Functions デプロイ
      # - name: Deploy Supabase Edge Functions
      #   run: supabase functions deploy

      # 6. フロントエンドを Vercel にデプロイ
      - name: Deploy Frontend to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token:       ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id:      ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id:  ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory:  .
          alias-domains:      https://pharma-crm-git-main-kosuke-fujimotos-projects.vercel.app/
