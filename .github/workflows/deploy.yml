name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # Supabase
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF:  ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD:  ${{ secrets.SUPABASE_DB_PASSWORD }}
      # Vercel
      VERCEL_TOKEN:      ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID:     ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      # 1. リポジトリ取得
      - uses: actions/checkout@v3

      # 2. Supabase CLI
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link & migrate Supabase
        run: |
          supabase link \
            --project-ref "$SUPABASE_PROJECT_REF" \
            --password    "$SUPABASE_DB_PASSWORD"
          supabase db push

      # 3. Node & Vercel CLI
      - name: Setup Node.js & Vercel CLI
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install -g vercel@latest

      # 4. ❶ Project Settings を取得（--yes で非対話）
      - name: Pull Vercel project settings
        run: |
          vercel pull --yes \
                      --environment=production \
                      --token  "$VERCEL_TOKEN" \
                      --scope  "$VERCEL_ORG_ID" \
                      --project-id "$VERCEL_PROJECT_ID"

      # 5. ❷ Build（--yes で settings が無い場合も自動取得）
      - name: Build with Vercel
        run: |
          vercel build --prod --yes \
                       --token "$VERCEL_TOKEN" \
                       --scope "$VERCEL_ORG_ID"

      # 6. ❸ Deploy（prebuilt artefact）
      - name: Deploy Frontend to Vercel
        id: vercel_deploy
        run: |
          DEPLOY_URL=$(vercel deploy --prebuilt --prod --yes \
                                     --token "$VERCEL_TOKEN" \
                                     --scope "$VERCEL_ORG_ID")
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"

      # 7. デプロイ URL 表示
      - name: Post deployment info
        run: echo "🚀 Frontend is live at: ${{ steps.vercel_deploy.outputs.url }}"
